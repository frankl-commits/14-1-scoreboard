
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>14.1 Scoreboard - V11.0 Banker</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231e1e1e%22 stroke=%22%2300e676%22 stroke-width=%225%22/><text x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23e0e0e0%22>14</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231e1e1e%22 stroke=%22%2300e676%22 stroke-width=%225%22/><text x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23e0e0e0%22>14</text></svg>">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-green: #2e7d32;
            --accent-red: #c62828;
            --accent-blue: #1565c0;
            --accent-orange: #ef6c00;
            --accent-grey: #616161;
            --accent-purple: #5e35b1; /* Banker Color */
            --active-border: #00e676;
            --balls-bg: #263238;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 8px; font-size: 0.9rem; min-height: 50px;
        }
        .top-bar input {
            background: var(--card-bg); border: 1px solid #444; color: white;
            padding: 8px; width: 80px; text-align: center; border-radius: 6px;
            font-size: 1.2rem; font-weight: bold;
        }
        .btn-small {
            background: #333; border: none; color: #aaa;
            padding: 8px 12px; border-radius: 6px; font-size: 0.8rem;
        }

        .table-status {
            display: flex; justify-content: center; align-items: center;
            background: var(--balls-bg); padding: 5px 10px; border-radius: 8px;
            margin-bottom: 15px; 
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            border: 1px solid #444;
            min-height: 45px;
        }
        
        .header-btns { display: flex; gap: 10px; width: 100%; justify-content: space-between; }
        .btn-header {
            background: #444; color: white; border: none;
            font-size: 0.85rem; padding: 8px 5px; border-radius: 6px;
            font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;
            cursor: pointer; flex: 1; 
        }

        /* --- SCOREBOARD --- */
        .scoreboard { display: flex; gap: 8px; flex: 1; margin-bottom: 20px; min-height: 220px; }
        .player-card {
            flex: 1; background: var(--card-bg); border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; align-items: center;
            position: relative; border: 2px solid transparent; transition: all 0.2s;
        }
        .player-card.active {
            border-color: var(--active-border); background-color: #252525;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.15);
        }
        .player-name-input {
            background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 4px;
            color: var(--text-color); font-size: 1.1rem; text-align: center; width: 100%;
            margin-bottom: 5px; font-weight: bold; padding: 4px;
        }
        .main-scores {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding: 5px 0;
        }
        .score-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .score-total { font-size: 3.5rem; font-weight: bold; line-height: 1; margin: 2px 0 10px 0; }
        .score-run { font-size: 2rem; color: var(--active-border); font-weight: bold; margin-bottom: 5px; }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; width: 100%; gap: 2px;
            background: #333; padding: 2px; border-radius: 4px; margin-top: auto;
        }
        .stat-box { background: var(--card-bg); text-align: center; padding: 4px 0; }
        .stat-val { font-size: 0.8rem; font-weight: bold; color: white; }
        .stat-lbl { font-size: 0.55rem; color: #aaa; }

        .winner-badge { display: none; position: absolute; top: 5px; right: 5px; background: gold; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.6rem; z-index: 10; }
        .foul-warning { display: none; position: absolute; top: 5px; left: 5px; background: var(--accent-red); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; z-index: 10; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- CONTROLS --- */
        .controls {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            grid-template-rows: 1fr 1fr 1fr; 
            gap: 10px; 
            min-height: 280px; 
            margin-bottom: 20px;
        }

        button {
            border: none; border-radius: 8px; color: white; font-size: 1rem; font-weight: bold;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        button:active { filter: brightness(0.8); transform: translateY(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        button:disabled { opacity: 0.3; filter: grayscale(100%); cursor: not-allowed; } 
        .btn-subtext { font-size: 0.65rem; font-weight: normal; opacity: 0.8; margin-top: 4px; display:block; }

        /* Button Positions */
        .btn-point { background-color: var(--accent-green); font-size: 2.5rem; grid-column: 1; grid-row: 1; }
        .btn-balls { background-color: #455a64; grid-column: 2; grid-row: 1; font-size: 1.2rem; border: 2px solid #555; }
        .btn-rack  { background-color: var(--accent-blue); grid-column: 3; grid-row: 1; }
        
        .btn-minus { background-color: #d84315; grid-column: 1; grid-row: 2; font-size: 1.5rem; }
        .btn-safe  { background-color: var(--accent-orange); grid-column: 2; grid-row: 2; }
        .btn-miss  { background-color: var(--accent-grey); grid-column: 3; grid-row: 2; border-left: 4px solid #aaa;}
        
        .btn-foul  { background-color: var(--accent-red); grid-column: 1; grid-row: 3; }
        /* Undo in the middle */
        .btn-undo  { background-color: #444; grid-column: 2; grid-row: 3; font-size: 1.2rem; }
        /* Banker button new position */
        .btn-banker { background-color: var(--accent-purple); grid-column: 3; grid-row: 3; border-left: 4px solid #9575cd; }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content { 
            background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; 
            width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; 
        }
        .modal-btn { margin: 10px; padding: 12px 24px; font-size: 1rem; border-radius: 4px; cursor: pointer; width: 100%; }

        .ball-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .ball-btn { 
            background: #333; color: white; border: 1px solid #555; padding: 15px 0; 
            border-radius: 8px; font-weight: bold; font-size: 1.2rem; 
        }
        .ball-btn:active { background: var(--accent-blue); }
        .ball-btn.disabled { opacity: 0.3; pointer-events: none; border-color: #222; }
        .ball-btn.current { border-color: var(--active-border); color: var(--active-border); background: #252525; }

        .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .stats-table th, .stats-table td { padding: 8px; text-align: center; border-bottom: 1px solid #333; }
        .stats-table .row-label { text-align: left; font-weight: bold; color: #aaa; font-size: 0.8rem; }
        .stats-table .highlight { color: var(--active-border); font-weight: bold; }
        
        .time-header { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .time-value { font-size: 1.1rem; font-weight: bold; color: white; margin-bottom: 15px; }

        /* --- LOG TABLE --- */
        .log-table-container {
            max-height: 60vh; overflow-y: auto; 
            border: 1px solid #333; border-radius: 6px;
        }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th {
            background: #252525; color: #aaa; padding: 8px 2px; 
            text-align: center; font-weight: normal; font-size: 0.7rem;
            position: sticky; top: 0; z-index: 2; border-bottom: 1px solid #444;
        }
        .log-table td { padding: 8px 2px; border-bottom: 1px solid #333; text-align: center; vertical-align: middle; }
        .col-nr { width: 10%; color: #666; font-size: 0.7rem; }
        .col-name { width: 25%; font-weight: bold; font-size:0.9rem;} 
        .col-sum { width: 15%; font-weight: bold; background: #222; border-left: 1px solid #333; color: var(--active-border); }
        .res-run { color: #fff; font-weight: bold; font-size: 1.1rem; }
        .res-safe { color: var(--accent-orange); font-size: 0.8rem; }
        .res-foul { color: var(--accent-red); font-weight: bold; }
        .res-miss { color: #777; font-size: 0.8rem; }
        .res-bank { color: var(--accent-purple); font-size: 0.8rem; font-weight: bold; }
        .sum-val  { color: var(--active-border); font-size: 0.9rem; }
        .empty-cell { background: #181818; }

    </style>
</head>
<body>

    <div class="top-bar">
        <button class="btn-small" onclick="resetGame(true)">RESET</button>
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:0.9rem; color:#aaa;">Ziel:</span> 
            <input type="number" id="targetScore" value="100" onchange="updateSettings()">
        </div>
    </div>

    <div class="table-status">
        <div class="header-btns">
             <button class="btn-header" onclick="openTimeStats()">‚è± Zeit</button>
             <button class="btn-header" onclick="openLog()">üìù Verlauf</button>
             <button class="btn-header" onclick="openStats()" style="background: var(--accent-blue);">üìä Stats</button>
        </div>
    </div>

    <div class="scoreboard">
        <div class="player-card active" id="p0-card" onclick="setManualActive(0)">
            <div class="winner-badge" id="p0-win">WIN</div>
            <div class="foul-warning" id="p0-foul-warn">2 FOULS!</div>
            <input type="text" class="player-name-input" id="p0-name" value="Spieler A" onchange="updateSettings()">
            <div class="main-scores">
                <div class="score-label">Total</div>
                <div class="score-total" id="p0-total">0</div>
                <div class="score-label">Aufnahme</div>
                <div class="score-run" id="p0-run">0</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="p0-inn">0</div><div class="stat-lbl">INN</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-avg">0.0</div><div class="stat-lbl">GD</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-hr">0</div><div class="stat-lbl">HR</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-pct">100%</div><div class="stat-lbl">%</div></div>
            </div>
        </div>

        <div class="player-card" id="p1-card" onclick="setManualActive(1)">
            <div class="winner-badge" id="p1-win">WIN</div>
            <div class="foul-warning" id="p1-foul-warn">2 FOULS!</div>
            <input type="text" class="player-name-input" id="p1-name" value="Spieler B" onchange="updateSettings()">
            <div class="main-scores">
                <div class="score-label">Total</div>
                <div class="score-total" id="p1-total">0</div>
                <div class="score-label">Aufnahme</div>
                <div class="score-run" id="p1-run">0</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="p1-inn">0</div><div class="stat-lbl">INN</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-avg">0.0</div><div class="stat-lbl">GD</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-hr">0</div><div class="stat-lbl">HR</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-pct">100%</div><div class="stat-lbl">%</div></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-point" id="btn-pt" onclick="actionPoint()">+1</button>
        <button class="btn-balls" id="btn-balls" onclick="openBallSelect()">15 B√§lle<span class="btn-subtext">‚úé</span></button>
        <button class="btn-rack" id="btn-rack" onclick="actionRack()">+14<span class="btn-subtext">RACK</span></button>
        
        <button class="btn-minus" onclick="actionMinusOne()">-1</button>
        <button class="btn-safe" onclick="actionSafety()">SAFE<span class="btn-subtext">Wechsel</span></button>
        <button class="btn-miss" onclick="actionMiss()">MISS<span class="btn-subtext">Wechsel</span></button>

        <button class="btn-foul" onclick="actionFoul()">FOUL<span class="btn-subtext">-1 Punkt</span></button>
        <button class="btn-undo" onclick="actionUndo()">UNDO</button>
        <button class="btn-banker" onclick="actionBankerMiss()">BANKER<span class="btn-subtext">Miss</span></button>
    </div>

    <div class="modal" id="ballModal">
        <div class="modal-content">
            <h3>B√§lle am Tisch</h3>
            <p style="color:#aaa; font-size:0.8rem; margin-bottom:15px;">Differenz wird als Punkte addiert.</p>
            <div class="ball-grid" id="ballGrid"></div>
            <button class="modal-btn" onclick="document.getElementById('ballModal').style.display='none'" style="background:#444; color:white;">Abbrechen</button>
        </div>
    </div>

    <div class="modal" id="statsModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Statistik</h3>
            <table class="stats-table">
                <thead><tr><th>Metric</th><th id="th-p0">A</th><th id="th-p1">B</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">Punkte</td><td id="st-p0-total" class="highlight">0</td><td id="st-p1-total" class="highlight">0</td></tr>
                    <tr><td class="row-label">Aufnahmen</td><td id="st-p0-inn">0</td><td id="st-p1-inn">0</td></tr>
                    <tr><td class="row-label">GD</td><td id="st-p0-avg">0.0</td><td id="st-p1-avg">0.0</td></tr>
                    <tr><td class="row-label">High Run</td><td id="st-p0-hr">0</td><td id="st-p1-hr">0</td></tr>
                    <tr><td class="row-label">Quote</td><td id="st-p0-qt">100%</td><td id="st-p1-qt">100%</td></tr>
                    
                    <tr style="border-top: 1px solid #444;"><td class="row-label" style="color:#ef6c00;">Safeties</td><td id="st-p0-safe">0</td><td id="st-p1-safe">0</td></tr>
                    <tr><td class="row-label" style="color:#aaa;">Miss</td><td id="st-p0-miss">0</td><td id="st-p1-miss">0</td></tr>
                    <tr><td class="row-label" style="color:var(--accent-purple);">Banker Miss</td><td id="st-p0-bank">0</td><td id="st-p1-bank">0</td></tr>
                    <tr><td class="row-label" style="color:#e53935;">Fouls</td><td id="st-p0-fouls">0</td><td id="st-p1-fouls">0</td></tr>
                </tbody>
            </table>
            <button class="modal-btn" onclick="document.getElementById('statsModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="logModal">
        <div class="modal-content">
            <h3>Match Verlauf</h3>
            <div class="log-table-container">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th class="col-nr">#</th>
                            <th class="col-name" id="log-th-p0">A</th>
                            <th class="col-sum">A ‚àë</th>
                            <th class="col-name" id="log-th-p1">B</th>
                            <th class="col-sum">B ‚àë</th>
                        </tr>
                    </thead>
                    <tbody id="logBody"></tbody>
                </table>
            </div>
            <button class="modal-btn" onclick="document.getElementById('logModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="timeModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">‚è± Zeit-Analyse</h3>
            <div class="time-header">Spielstart / Ende</div>
            <div class="time-value"><span id="t-start">-</span> / <span id="t-end">l√§uft...</span></div>
            <table class="stats-table">
                <thead><tr><th>Metrik</th><th id="th-p0-t">A</th><th id="th-p1-t">B</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">√ò Aufnahme</td><td id="t-p0-avg">0s</td><td id="t-p1-avg">0s</td></tr>
                    <tr><td class="row-label" style="color:#ef6c00;">√ò Safety</td><td id="t-p0-safe-avg">-</td><td id="t-p1-safe-avg">-</td></tr>
                    <tr><td class="row-label" style="color:#aaa;">√ò Miss</td><td id="t-p0-miss-avg">-</td><td id="t-p1-miss-avg">-</td></tr>
                    <tr><td class="row-label" style="color:var(--accent-purple);">√ò Banker</td><td id="t-p0-bank-avg">-</td><td id="t-p1-bank-avg">-</td></tr>
                    
                    <tr style="border-top: 1px solid #444;">
                        <td class="row-label" style="color:var(--active-border);">Schnellste <span style="font-size:0.6rem;">(Sek/Ball)</span></td>
                        <td id="t-p0-fast">-</td><td id="t-p1-fast">-</td>
                    </tr>
                    <tr>
                        <td class="row-label" style="color:#757575;">Langsamste <span style="font-size:0.6rem;">(Sek/Ball)</span></td>
                        <td id="t-p0-slow">-</td><td id="t-p1-slow">-</td>
                    </tr>
                </tbody>
            </table>
            <button class="modal-btn" onclick="document.getElementById('timeModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>Neues Spiel?</h3>
            <button class="modal-btn" onclick="confirmReset()" style="background:var(--accent-red); color:white; border:none;">Ja, Alles l√∂schen</button>
            <button class="modal-btn" onclick="closeModal()" style="background:#444; color:white; border:none;">Abbrechen</button>
        </div>
    </div>

    <script>
        // --- Core Functions ---
        function saveAndRender() { saveState(); render(); }
        function pushHistory() { if(historyStack.length > 50) historyStack.shift(); historyStack.push(JSON.parse(JSON.stringify(state))); }

        // --- State Management ---
        let defaultPlayer = { 
            name: "Spieler", total: 0, run: 0, innings: 0, 
            highRun: 0, misses: 0, safeties: 0, fouls: 0, consecutiveFouls: 0,
            bankerMisses: 0, // NEW Tracker
            inningLogs: [] 
        };

        let state = {
            gameStartTime: Date.now(), gameEndTime: null, currentInningStart: Date.now(),
            players: [ { ...defaultPlayer, name: "Spieler A", inningLogs: [] }, { ...defaultPlayer, name: "Spieler B", inningLogs: [] } ],
            activePlayer: 0, target: 100, ballsOnTable: 15
        };

        let historyStack = [];

        window.onload = function() { loadState(); render(); };

        function isGameOver() {
            return (state.players[0].total >= state.target || state.players[1].total >= state.target);
        }

        // --- Actions ---
        function actionPoint() {
            if(isGameOver()) return;
            pushHistory();
            const p = state.players[state.activePlayer];
            p.run++; p.total++;
            if(p.run > p.highRun) p.highRun = p.run;
            p.consecutiveFouls = 0; 
            if(state.ballsOnTable > 0) state.ballsOnTable--;
            if(state.ballsOnTable === 1) state.ballsOnTable = 15; 
            
            // Check WIN immediately
            if(p.total >= state.target) {
                endInning('win'); return;
            }
            saveAndRender();
        }

        function actionMinusOne() {
            const p = state.players[state.activePlayer];
            if(p.run > 0) {
                pushHistory(); p.run--; p.total--;
                if(state.ballsOnTable < 15) state.ballsOnTable++;
                saveAndRender();
            }
        }

        function actionRack() {
            if(isGameOver()) return;
            pushHistory();
            const p = state.players[state.activePlayer];
            let pointsToAdd = state.ballsOnTable > 1 ? (state.ballsOnTable - 1) : 0;
            p.total += pointsToAdd; p.run += pointsToAdd;
            if(p.run > p.highRun) p.highRun = p.run;
            p.consecutiveFouls = 0; state.ballsOnTable = 15;
            
            if(p.total >= state.target) { endInning('win'); return; }
            saveAndRender();
        }

        function actionSafety() { pushHistory(); state.players[state.activePlayer].safeties++; state.players[state.activePlayer].consecutiveFouls = 0; endInning('safe', 0); }
        function actionMiss() { pushHistory(); state.players[state.activePlayer].misses++; state.players[state.activePlayer].consecutiveFouls = 0; endInning('miss', 0); }
        
        // NEW BANKER ACTION
        function actionBankerMiss() { 
            pushHistory(); 
            // Banker Miss counts as Miss generally? Or separate? 
            // User requested separate stat. We count it in bankerMisses.
            // For Quote: Attempt = Potted + Miss + BankerMiss + Foul
            state.players[state.activePlayer].bankerMisses++; 
            state.players[state.activePlayer].consecutiveFouls = 0; 
            endInning('banker-miss', 0); 
        }

        function actionFoul() { 
            pushHistory(); const p = state.players[state.activePlayer]; 
            p.consecutiveFouls++; p.fouls++; 
            let deduction = -1;
            if (p.consecutiveFouls >= 3) { 
                p.total -= 15; deduction = -15;
                alert("ACHTUNG: 3. Foul!\n-15 Punkte & Re-Rack."); 
                p.consecutiveFouls = 0; state.ballsOnTable = 15; 
            } else { p.total--; } 
            endInning('foul', deduction); 
        }

        function endInning(type = 'standard', manualDelta = null) {
            const p = state.players[state.activePlayer];
            let now = Date.now();
            let durationSec = (now - state.currentInningStart) / 1000;
            
            let delta = p.run; 
            if(type === 'foul') delta = manualDelta;

            p.inningLogs.push({ duration: durationSec, run: p.run, type: type, timestamp: now, scoreDelta: delta });
            
            state.currentInningStart = now; 
            
            if(type !== 'win') {
                p.innings++; 
                p.run = 0;
                switchPlayer();
            } else {
                state.gameEndTime = now;
            }
            saveAndRender();
        }

        function actionUndo() { if (historyStack.length === 0) return; state = historyStack.pop(); saveAndRender(); }
        function switchPlayer() { state.activePlayer = state.activePlayer === 0 ? 1 : 0; }
        function setManualActive(index) { if(state.activePlayer !== index) { pushHistory(); state.currentInningStart = Date.now(); state.players[state.activePlayer].run = 0; state.activePlayer = index; saveAndRender(); } }

        // --- Dialogs ---
        function openBallSelect() {
            if(isGameOver()) return;
            const grid = document.getElementById('ballGrid'); grid.innerHTML = '';
            for(let i=0; i<=15; i++) {
                let btn = document.createElement('button'); btn.className = 'ball-btn'; btn.innerText = i;
                if(i === state.ballsOnTable) btn.classList.add('current');
                if(i > state.ballsOnTable) btn.classList.add('disabled'); else btn.onclick = function() { selectBalls(i); };
                grid.appendChild(btn);
            }
            document.getElementById('ballModal').style.display = 'flex';
        }

        function selectBalls(n) {
            pushHistory();
            let diff = state.ballsOnTable - n; 
            const p = state.players[state.activePlayer];
            p.run += diff; p.total += diff;
            if(p.run > p.highRun) p.highRun = p.run;
            if(diff > 0) p.consecutiveFouls = 0; 
            state.ballsOnTable = n; if(state.ballsOnTable === 1) state.ballsOnTable = 15;
            
            if(p.total >= state.target) {
                document.getElementById('ballModal').style.display = 'none';
                endInning('win');
                return;
            }

            document.getElementById('ballModal').style.display = 'none'; saveAndRender();
        }

        // --- LOG LOGIC ---
        function openLog() {
            const tbody = document.getElementById('logBody');
            tbody.innerHTML = '';
            
            document.getElementById('log-th-p0').innerText = state.players[0].name.substring(0,8);
            document.getElementById('log-th-p1').innerText = state.players[1].name.substring(0,8);

            let maxInnings = Math.max(state.players[0].inningLogs.length, state.players[1].inningLogs.length);
            let totalA = 0;
            let totalB = 0;

            for (let i = 0; i < maxInnings; i++) {
                let logA = state.players[0].inningLogs[i];
                let logB = state.players[1].inningLogs[i];
                let tr = document.createElement('tr');

                // Render Cell A
                let cellResA = "", cellSumA = "";
                if(logA) {
                    let d = (logA.scoreDelta !== undefined) ? logA.scoreDelta : (logA.type==='foul'?-1:logA.run);
                    totalA += d;
                    
                    let suffix = "";
                    let cls = "res-run";
                    if(logA.type==='foul') { suffix = "(F)"; cls = "res-foul"; }
                    else if(logA.type==='safe') { suffix = "(S)"; cls = "res-safe"; }
                    else if(logA.type==='miss') { suffix = "(M)"; cls = "res-miss"; }
                    else if(logA.type==='banker-miss') { suffix = "(B)"; cls = "res-bank"; }
                    else if(logA.type==='win') { suffix = "üèÜ"; cls = "res-run"; }
                    
                    let val = (logA.type==='foul') ? d : logA.run;
                    cellResA = `<span class="${cls}">${val} ${suffix}</span>`;
                    cellSumA = `<span class="sum-val">${totalA}</span>`;
                }

                // Render Cell B
                let cellResB = "", cellSumB = "";
                if(logB) {
                    let d = (logB.scoreDelta !== undefined) ? logB.scoreDelta : (logB.type==='foul'?-1:logB.run);
                    totalB += d;

                    let suffix = "";
                    let cls = "res-run";
                    if(logB.type==='foul') { suffix = "(F)"; cls = "res-foul"; }
                    else if(logB.type==='safe') { suffix = "(S)"; cls = "res-safe"; }
                    else if(logB.type==='miss') { suffix = "(M)"; cls = "res-miss"; }
                    else if(logB.type==='banker-miss') { suffix = "(B)"; cls = "res-bank"; }
                    else if(logB.type==='win') { suffix = "üèÜ"; cls = "res-run"; }
                    
                    let val = (logB.type==='foul') ? d : logB.run;
                    cellResB = `<span class="${cls}">${val} ${suffix}</span>`;
                    cellSumB = `<span class="sum-val">${totalB}</span>`;
                }

                tr.innerHTML = `
                    <td class="col-nr">${i + 1}</td>
                    <td class="${!logA ? 'empty-cell' : ''}">${cellResA}</td>
                    <td class="col-sum ${!logA ? 'empty-cell' : ''}">${cellSumA}</td>
                    <td class="${!logB ? 'empty-cell' : ''}">${cellResB}</td>
                    <td class="col-sum ${!logB ? 'empty-cell' : ''}">${cellSumB}</td>
                `;
                tbody.appendChild(tr);
            }
            document.getElementById('logModal').style.display = 'flex';
        }

        // --- Helpers & Render ---
        function calculateStats(p) {
            let avg = (p.total / (p.innings === 0 && p.total > 0 ? 1 : Math.max(1, p.innings))).toFixed(2);
            let positivePots = Math.max(0, p.total); 
            let estimatedPots = positivePots + p.fouls; 
            // Attempt includes Miss + BankerMiss
            let b = p.bankerMisses || 0;
            let attempts = estimatedPots + p.misses + b + p.fouls; 
            let pct = attempts === 0 ? 100 : Math.round((estimatedPots / attempts) * 100);
            return { avg, pct };
        }

        function formatTime(ts) { if(!ts) return "-"; return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

        function calculateTimeStats(p) {
            if (p.inningLogs.length === 0) return { avg: "0s", fast: "-", slow: "-", safeAvg: "-", errAvg: "-" };
            let total=0, safeSum=0, safeCnt=0, missSum=0, missCnt=0, bankSum=0, bankCnt=0;
            let minSpb = Infinity, maxSpb = 0;
            
            p.inningLogs.forEach(log => {
                total += log.duration;
                if (log.run > 0) {
                    let spb = log.duration / log.run;
                    if (spb < minSpb) minSpb = spb;
                    if (spb > maxSpb) maxSpb = spb;
                }
                if (log.type === 'safe') { safeSum += log.duration; safeCnt++; }
                else if (log.type === 'miss' || log.type === 'foul') { missSum += log.duration; missCnt++; }
                else if (log.type === 'banker-miss') { bankSum += log.duration; bankCnt++; }
            });
            
            return {
                avg: Math.round(total/p.inningLogs.length) + "s",
                fast: minSpb===Infinity?"-":Math.round(minSpb)+"s",
                slow: maxSpb===0?"-":Math.round(maxSpb)+"s",
                safeAvg: safeCnt===0?"-":Math.round(safeSum/safeCnt)+"s",
                missAvg: missCnt===0?"-":Math.round(missSum/missCnt)+"s",
                bankAvg: bankCnt===0?"-":Math.round(bankSum/bankCnt)+"s"
            };
        }

        function render() {
            const p0 = state.players[0]; const p1 = state.players[1]; const active = state.activePlayer;
            const finished = isGameOver();
            
            if (finished && !state.gameEndTime) state.gameEndTime = Date.now();
            else if (!finished) state.gameEndTime = null;

            // Lock controls
            const btnPt = document.getElementById('btn-pt');
            const btnRack = document.getElementById('btn-rack');
            const btnBalls = document.getElementById('btn-balls');
            
            if(finished) {
                btnPt.disabled = true; btnRack.disabled = true; btnBalls.disabled = true;
                btnRack.style.backgroundColor = "#555";
                btnPt.style.backgroundColor = "#555";
                btnBalls.style.backgroundColor = "#333";
                btnBalls.style.border = "1px solid #444";
            } else {
                btnPt.disabled = false; btnRack.disabled = false; btnBalls.disabled = false;
                btnPt.style.backgroundColor = "var(--accent-green)";
                btnBalls.style.backgroundColor = "#455a64";
                
                let potPts = state.ballsOnTable > 1 ? (state.ballsOnTable - 1) : 0;
                if (potPts > 0) { 
                    btnRack.innerHTML = `+${potPts} <span class="btn-subtext">REST & RACK</span>`; 
                    btnRack.style.backgroundColor = "var(--accent-blue)"; 
                } else { 
                    btnRack.innerHTML = `RACK <span class="btn-subtext">Neu aufbauen</span>`; 
                    btnRack.style.backgroundColor = "#555"; 
                }
            }

            document.getElementById('btn-balls').innerHTML = `${state.ballsOnTable} B√§lle<span class="btn-subtext">‚úé</span>`;
            
            document.getElementById('p0-card').className = `player-card ${active === 0 ? 'active' : ''}`;
            document.getElementById('p1-card').className = `player-card ${active === 1 ? 'active' : ''}`;
            document.getElementById('p0-foul-warn').style.display = (p0.consecutiveFouls === 2) ? 'block' : 'none';
            document.getElementById('p1-foul-warn').style.display = (p1.consecutiveFouls === 2) ? 'block' : 'none';

            document.getElementById('p0-total').innerText = p0.total; document.getElementById('p0-run').innerText = p0.run;
            document.getElementById('p1-total').innerText = p1.total; document.getElementById('p1-run').innerText = p1.run;

            const s0 = calculateStats(p0); const s1 = calculateStats(p1);
            document.getElementById('p0-inn').innerText = p0.innings; document.getElementById('p0-avg').innerText = s0.avg;
            document.getElementById('p0-hr').innerText = p0.highRun; document.getElementById('p0-pct').innerText = s0.pct + "%";
            document.getElementById('p1-inn').innerText = p1.innings; document.getElementById('p1-avg').innerText = s1.avg;
            document.getElementById('p1-hr').innerText = p1.highRun; document.getElementById('p1-pct').innerText = s1.pct + "%";
            
            document.getElementById('p0-win').style.display = (p0.total >= state.target) ? 'block' : 'none';
            document.getElementById('p1-win').style.display = (p1.total >= state.target) ? 'block' : 'none';
        }

        function openStats() {
            const p0 = state.players[0]; const p1 = state.players[1];
            const s0 = calculateStats(p0); const s1 = calculateStats(p1);
            document.getElementById('th-p0').innerText = p0.name; document.getElementById('th-p1').innerText = p1.name;
            const fill = (id, val) => document.getElementById(id).innerText = val;
            fill('st-p0-total', p0.total); fill('st-p1-total', p1.total);
            fill('st-p0-inn', p0.innings); fill('st-p1-inn', p1.innings);
            fill('st-p0-avg', s0.avg);     fill('st-p1-avg', s1.avg);
            fill('st-p0-hr', p0.highRun);  fill('st-p1-hr', p1.highRun);
            fill('st-p0-qt', s0.pct+"%");  fill('st-p1-qt', s1.pct+"%");
            fill('st-p0-safe', p0.safeties); fill('st-p1-safe', p1.safeties);
            fill('st-p0-miss', p0.misses); fill('st-p1-miss', p1.misses);
            fill('st-p0-bank', p0.bankerMisses || 0); fill('st-p1-bank', p1.bankerMisses || 0);
            fill('st-p0-fouls', p0.fouls); fill('st-p1-fouls', p1.fouls);
            document.getElementById('statsModal').style.display = 'flex';
        }

        function openTimeStats() {
            const p0 = state.players[0]; const p1 = state.players[1];
            const t0 = calculateTimeStats(p0); const t1 = calculateTimeStats(p1);
            document.getElementById('th-p0-t').innerText = p0.name; document.getElementById('th-p1-t').innerText = p1.name;
            document.getElementById('t-start').innerText = formatTime(state.gameStartTime);
            document.getElementById('t-end').innerText = state.gameEndTime ? formatTime(state.gameEndTime) : "l√§uft...";
            document.getElementById('t-p0-avg').innerText = t0.avg; document.getElementById('t-p1-avg').innerText = t1.avg;
            document.getElementById('t-p0-safe-avg').innerText = t0.safeAvg; document.getElementById('t-p1-safe-avg').innerText = t1.safeAvg;
            document.getElementById('t-p0-miss-avg').innerText = t0.missAvg; document.getElementById('t-p1-miss-avg').innerText = t1.missAvg;
            document.getElementById('t-p0-bank-avg').innerText = t0.bankAvg; document.getElementById('t-p1-bank-avg').innerText = t1.bankAvg;
            document.getElementById('t-p0-fast').innerText = t0.fast; document.getElementById('t-p1-fast').innerText = t1.fast;
            document.getElementById('t-p0-slow').innerText = t0.slow; document.getElementById('t-p1-slow').innerText = t1.slow;
            document.getElementById('timeModal').style.display = 'flex';
        }

        function saveState() { localStorage.setItem('141_final_v11_0', JSON.stringify(state)); }
        function loadState() {
            const saved = localStorage.getItem('141_final_v11_0');
            if (saved) {
                try {
                    let loaded = JSON.parse(saved);
                    if(typeof loaded.ballsOnTable === 'undefined') loaded.ballsOnTable = 15;
                    loaded.players.forEach(p => { 
                        if(!p.inningLogs) p.inningLogs = []; 
                        if(!p.bankerMisses) p.bankerMisses = 0;
                    });
                    state = loaded;
                    document.getElementById('p0-name').value = state.players[0].name;
                    document.getElementById('p1-name').value = state.players[1].name;
                    document.getElementById('targetScore').value = state.target;
                } catch(e) {}
            }
        }
        function updateSettings() { state.players[0].name=document.getElementById('p0-name').value; state.players[1].name=document.getElementById('p1-name').value; state.target=parseInt(document.getElementById('targetScore').value)||100; saveAndRender(); }
        function resetGame(ask) {
            if(ask) document.getElementById('resetModal').style.display = 'flex';
            else { state.players = [ { ...defaultPlayer, name: state.players[0].name, inningLogs: [] }, { ...defaultPlayer, name: state.players[1].name, inningLogs: [] } ]; state.activePlayer = 0; state.ballsOnTable = 15; state.gameStartTime = Date.now(); state.gameEndTime = null; state.currentInningStart = Date.now(); historyStack = []; saveAndRender(); }
        }
        function confirmReset() { resetGame(false); closeModal(); }
        function closeModal() { document.getElementById('resetModal').style.display = 'none'; }
    </script>
</body>
</html>