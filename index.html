<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>14.1 Scoreboard - V7.0 Analyst</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231e1e1e%22 stroke=%22%2300e676%22 stroke-width=%225%22/><text x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23e0e0e0%22>14</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231e1e1e%22 stroke=%22%2300e676%22 stroke-width=%225%22/><text x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23e0e0e0%22>14</text></svg>">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-green: #2e7d32;
            --accent-red: #c62828;
            --accent-blue: #1565c0;
            --accent-orange: #ef6c00;
            --accent-grey: #616161;
            --active-border: #00e676;
            --balls-bg: #263238;
            --chart-bar-bg: #333;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 8px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- TOP BAR --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 8px; font-size: 0.9rem; min-height: 50px;
        }
        .top-bar input {
            background: var(--card-bg); border: 1px solid #444; color: white;
            padding: 8px; width: 80px; text-align: center; border-radius: 6px;
            font-size: 1.2rem; font-weight: bold;
        }
        .btn-small {
            background: #333; border: none; color: #aaa;
            padding: 8px 12px; border-radius: 6px; font-size: 0.8rem;
        }

        /* --- TABLE STATUS --- */
        .table-status {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--balls-bg); padding: 5px 10px; border-radius: 8px;
            margin-bottom: 10px; font-weight: bold; 
            font-size: 1.3rem; 
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            border: 1px solid #444;
            min-height: 50px;
            cursor: pointer; 
        }
        .table-status:active { background: #37474f; }
        
        .ts-info { display: flex; align-items: center; flex: 1; }
        .ball-icon {
            display: inline-block; width: 18px; height: 18px; background: white; 
            border-radius: 50%; margin-right: 10px;
        }
        .edit-hint { font-size: 0.8rem; color: #888; margin-left: auto; margin-right: 10px; font-weight: normal; }
        
        .header-btns { display: flex; gap: 8px; }
        .btn-header {
            background: #444; color: white; border: none;
            font-size: 0.8rem; padding: 6px 10px; border-radius: 6px;
            font-weight: bold; display: flex; align-items: center; gap: 5px;
            cursor: pointer;
        }

        /* --- SCOREBOARD --- */
        .scoreboard { display: flex; gap: 8px; flex: 1; margin-bottom: 15px; }
        .player-card {
            flex: 1; background: var(--card-bg); border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; align-items: center;
            position: relative; border: 2px solid transparent; transition: all 0.2s;
        }
        .player-card.active {
            border-color: var(--active-border); background-color: #252525;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.15);
        }
        .player-name-input {
            background: rgba(0,0,0,0.2); border: 1px solid transparent; border-radius: 4px;
            color: var(--text-color); font-size: 1.1rem; text-align: center; width: 100%;
            margin-bottom: 5px; font-weight: bold; padding: 4px;
        }
        .main-scores {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding: 10px 0;
        }
        .score-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .score-total { font-size: 3.5rem; font-weight: bold; line-height: 1; margin: 2px 0 10px 0; }
        .score-run { font-size: 2rem; color: var(--active-border); font-weight: bold; margin-bottom: 5px; }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; width: 100%; gap: 2px;
            background: #333; padding: 2px; border-radius: 4px; margin-top: auto;
        }
        .stat-box { background: var(--card-bg); text-align: center; padding: 4px 0; }
        .stat-val { font-size: 0.9rem; font-weight: bold; color: white; }
        .stat-lbl { font-size: 0.6rem; color: #aaa; }

        .winner-badge {
            display: none; position: absolute; top: 5px; right: 5px;
            background: gold; color: black; padding: 2px 6px;
            border-radius: 4px; font-weight: bold; font-size: 0.6rem; z-index: 10;
        }
        .foul-warning {
            display: none; position: absolute; top: 5px; left: 5px;
            background: var(--accent-red); color: white; padding: 2px 6px;
            border-radius: 4px; font-weight: bold; font-size: 0.7rem; z-index: 10;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- CONTROLS --- */
        .controls {
            display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1.5fr 1fr 1fr;
            gap: 8px; min-height: 300px; margin-bottom: 20px;
        }
        @media (orientation: landscape) { .controls { min-height: 250px; } }

        button {
            border: none; border-radius: 6px; color: white; font-size: 1rem; font-weight: bold;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            text-align: center;
        }
        button:active { filter: brightness(0.8); transform: scale(0.98); }
        .btn-subtext { font-size: 0.6rem; font-weight: normal; opacity: 0.8; margin-top: 2px; }

        .btn-point { grid-column: 1 / span 2; grid-row: 1; background-color: var(--accent-green); font-size: 3.5rem; }
        .btn-rack  { background-color: var(--accent-blue); grid-column: 3; grid-row: 1; }
        .btn-minus { background-color: #d84315; grid-column: 1; grid-row: 2; font-size: 1.5rem; }
        .btn-safe  { background-color: var(--accent-orange); grid-column: 2; grid-row: 2; }
        .btn-miss  { background-color: var(--accent-grey); grid-column: 3; grid-row: 2; border-left: 4px solid #aaa;}
        .btn-foul  { background-color: var(--accent-red); grid-column: 1; grid-row: 3; }
        .btn-undo  { background-color: #444; grid-column: 3; grid-row: 3; }
        .btn-spacer { background: transparent; grid-column: 2; grid-row: 3; pointer-events: none;}

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 8px; text-align: center; width: 95%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .modal-btn { margin: 10px; padding: 12px 24px; font-size: 1rem; border-radius: 4px; cursor: pointer; width: 100%; }

        .ball-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .ball-btn { 
            background: #333; color: white; border: 1px solid #555; padding: 15px 0; 
            border-radius: 8px; font-weight: bold; font-size: 1.2rem; 
        }
        .ball-btn:active { background: var(--accent-blue); }
        .ball-btn.disabled { opacity: 0.3; pointer-events: none; border-color: #222; }
        .ball-btn.current { border-color: var(--active-border); color: var(--active-border); background: #252525; }

        .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .stats-table th, .stats-table td { padding: 8px; text-align: center; border-bottom: 1px solid #333; }
        .stats-table .row-label { text-align: left; font-weight: bold; color: #aaa; font-size: 0.8rem; }
        .stats-table .highlight { color: var(--active-border); font-weight: bold; }
        
        .time-header { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .time-value { font-size: 1.1rem; font-weight: bold; color: white; margin-bottom: 15px; }

        /* --- CHART STYLES --- */
        .chart-container {
            display: flex; height: 150px; align-items: flex-end; gap: 4px; 
            padding: 10px; background: #252525; border-radius: 6px; margin-bottom: 20px;
            overflow-x: auto;
        }
        .chart-bar-group {
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            flex: 1; min-width: 10px;
        }
        .chart-bar {
            width: 100%; background: #555; border-radius: 2px 2px 0 0;
            transition: height 0.3s; position: relative;
        }
        .chart-bar.p0 { background: var(--accent-green); opacity: 0.7; }
        .chart-bar.p1 { background: var(--accent-blue); opacity: 0.7; }
        .chart-bar:hover { opacity: 1; }
        .chart-label { font-size: 0.6rem; color: #888; margin-top: 2px; }

    </style>
</head>
<body>

    <div class="top-bar">
        <button class="btn-small" onclick="resetGame(true)">RESET</button>
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:0.9rem; color:#aaa;">Ziel:</span> 
            <input type="number" id="targetScore" value="100" onchange="updateSettings()">
        </div>
    </div>

    <div class="table-status">
        <div class="ts-info" onclick="openBallSelect()">
            <span class="ball-icon"></span>
            <span id="balls-display">15 B√§lle</span>
            <span class="edit-hint">‚úé √§ndern</span>
        </div>
        <div class="header-btns">
             <button class="btn-header" onclick="openGraph()">üìà Graph</button>
             <button class="btn-header" onclick="openStats()" style="background: var(--accent-blue);">üìä Stats</button>
        </div>
    </div>

    <div class="scoreboard">
        <div class="player-card active" id="p0-card" onclick="setManualActive(0)">
            <div class="winner-badge" id="p0-win">WIN</div>
            <div class="foul-warning" id="p0-foul-warn">2 FOULS!</div>
            <input type="text" class="player-name-input" id="p0-name" value="Spieler A" onchange="updateSettings()">
            <div class="main-scores">
                <div class="score-label">Total</div>
                <div class="score-total" id="p0-total">0</div>
                <div class="score-label">Aufnahme</div>
                <div class="score-run" id="p0-run">0</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="p0-inn">0</div><div class="stat-lbl">INN</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-avg">0.0</div><div class="stat-lbl">GD</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-hr">0</div><div class="stat-lbl">HR</div></div>
                <div class="stat-box"><div class="stat-val" id="p0-pct">100%</div><div class="stat-lbl">%</div></div>
            </div>
        </div>

        <div class="player-card" id="p1-card" onclick="setManualActive(1)">
            <div class="winner-badge" id="p1-win">WIN</div>
            <div class="foul-warning" id="p1-foul-warn">2 FOULS!</div>
            <input type="text" class="player-name-input" id="p1-name" value="Spieler B" onchange="updateSettings()">
            <div class="main-scores">
                <div class="score-label">Total</div>
                <div class="score-total" id="p1-total">0</div>
                <div class="score-label">Aufnahme</div>
                <div class="score-run" id="p1-run">0</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="p1-inn">0</div><div class="stat-lbl">INN</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-avg">0.0</div><div class="stat-lbl">GD</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-hr">0</div><div class="stat-lbl">HR</div></div>
                <div class="stat-box"><div class="stat-val" id="p1-pct">100%</div><div class="stat-lbl">%</div></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-point" onclick="actionPoint()">+1</button>
        <button class="btn-rack" id="btn-rack" onclick="actionRack()">+14<span class="btn-subtext">RACK</span></button>
        
        <button class="btn-minus" onclick="actionMinusOne()">-1</button>
        <button class="btn-safe" onclick="actionSafety()">SAFE<span class="btn-subtext">Wechsel</span></button>
        <button class="btn-miss" onclick="actionMiss()">MISS<span class="btn-subtext">Wechsel</span></button>

        <button class="btn-foul" onclick="actionFoul()">FOUL<span class="btn-subtext">-1 Punkt</span></button>
        <div class="btn-spacer"></div>
        <button class="btn-undo" onclick="actionUndo()">UNDO</button>
    </div>

    <div class="modal" id="ballModal">
        <div class="modal-content">
            <h3>B√§lle am Tisch</h3>
            <p style="color:#aaa; font-size:0.8rem; margin-bottom:15px;">Differenz wird als Punkte addiert.</p>
            <div class="ball-grid" id="ballGrid"></div>
            <button class="modal-btn" onclick="document.getElementById('ballModal').style.display='none'" style="background:#444; color:white;">Abbrechen</button>
        </div>
    </div>

    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0;">Statistik</h3>
                <button onclick="openTimeStats()" style="background:#444; border:none; color:#aaa; font-size:0.8rem; padding:5px 10px; border-radius:4px;">‚è± Details</button>
            </div>

            <table class="stats-table">
                <thead>
                    <tr><th style="text-align:left;">Run Verteilung</th><th>A</th><th>B</th></tr>
                </thead>
                <tbody>
                    <tr><td class="row-label" style="color:#777;">&lt; 5 B√§lle</td><td id="d-p0-low">0</td><td id="d-p1-low">0</td></tr>
                    <tr><td class="row-label" style="color:var(--text-color);">5 - 14 B√§lle</td><td id="d-p0-mid">0</td><td id="d-p1-mid">0</td></tr>
                    <tr><td class="row-label" style="color:var(--active-border);">15+ B√§lle (Break)</td><td id="d-p0-high">0</td><td id="d-p1-high">0</td></tr>
                </tbody>
            </table>

            <h4 style="margin:20px 0 10px 0; color:#aaa; font-size:0.9rem; text-transform:uppercase;">Overview</h4>
            <table class="stats-table">
                <thead><tr><th></th><th>A</th><th>B</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">Punkte</td><td id="st-p0-total" class="highlight">0</td><td id="st-p1-total" class="highlight">0</td></tr>
                    <tr><td class="row-label">Aufnahmen</td><td id="st-p0-inn">0</td><td id="st-p1-inn">0</td></tr>
                    <tr><td class="row-label">GD</td><td id="st-p0-avg">0.0</td><td id="st-p1-avg">0.0</td></tr>
                    <tr><td class="row-label">High Run</td><td id="st-p0-hr">0</td><td id="st-p1-hr">0</td></tr>
                    <tr><td class="row-label">Quote</td><td id="st-p0-qt">100%</td><td id="st-p1-qt">100%</td></tr>
                    <tr style="border-top: 1px solid #444;"><td class="row-label" style="color:#ef6c00;">Safeties</td><td id="st-p0-safe">0</td><td id="st-p1-safe">0</td></tr>
                    <tr><td class="row-label" style="color:#aaa;">Miss</td><td id="st-p0-miss">0</td><td id="st-p1-miss">0</td></tr>
                    <tr><td class="row-label" style="color:#e53935;">Fouls</td><td id="st-p0-fouls">0</td><td id="st-p1-fouls">0</td></tr>
                </tbody>
            </table>
            <button class="modal-btn" onclick="document.getElementById('statsModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="graphModal">
        <div class="modal-content" style="max-width:95%;">
            <h3>Match Flow</h3>
            <p style="color:#aaa; font-size:0.8rem;">Run pro Aufnahme</p>
            
            <div class="chart-container" id="matchChart">
                </div>
            <div style="display:flex; justify-content:center; gap:15px; font-size:0.8rem; margin-bottom:15px;">
                <span style="color:var(--accent-green)">‚ñ† Spieler A</span>
                <span style="color:var(--accent-blue)">‚ñ† Spieler B</span>
            </div>

            <button class="modal-btn" onclick="document.getElementById('graphModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="timeModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">‚è± Zeit-Analyse</h3>
            <div class="time-header">Spielstart / Ende</div>
            <div class="time-value"><span id="t-start">-</span> / <span id="t-end">l√§uft...</span></div>

            <table class="stats-table">
                <thead><tr><th>Metrik</th><th id="th-p0-t">A</th><th id="th-p1-t">B</th></tr></thead>
                <tbody>
                    <tr><td class="row-label">√ò Aufnahme</td><td id="t-p0-avg">0s</td><td id="t-p1-avg">0s</td></tr>
                    <tr><td class="row-label" style="color:#ef6c00;">√ò Safety</td><td id="t-p0-safe-avg">-</td><td id="t-p1-safe-avg">-</td></tr>
                    <tr><td class="row-label" style="color:#e53935;">√ò Fehler</td><td id="t-p0-err-avg">-</td><td id="t-p1-err-avg">-</td></tr>
                    <tr style="border-top: 1px solid #444;">
                        <td class="row-label" style="color:var(--active-border);">Schnellste <span style="font-size:0.6rem;">(Sek/Ball)</span></td>
                        <td id="t-p0-fast">-</td><td id="t-p1-fast">-</td>
                    </tr>
                    <tr>
                        <td class="row-label" style="color:#757575;">Langsamste <span style="font-size:0.6rem;">(Sek/Ball)</span></td>
                        <td id="t-p0-slow">-</td><td id="t-p1-slow">-</td>
                    </tr>
                </tbody>
            </table>
            <button class="modal-btn" onclick="document.getElementById('timeModal').style.display='none'" style="background:#333; color:white;">Schlie√üen</button>
        </div>
    </div>

    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>Neues Spiel?</h3>
            <button class="modal-btn" onclick="confirmReset()" style="background:var(--accent-red); color:white; border:none;">Ja, Alles l√∂schen</button>
            <button class="modal-btn" onclick="closeModal()" style="background:#444; color:white; border:none;">Abbrechen</button>
        </div>
    </div>

    <script>
        // --- State ---
        let defaultPlayer = { 
            name: "Spieler", total: 0, run: 0, innings: 0, 
            highRun: 0, misses: 0, safeties: 0, fouls: 0, consecutiveFouls: 0,
            inningLogs: [] // { duration, run, type, timestamp }
        };

        let state = {
            gameStartTime: Date.now(), gameEndTime: null, currentInningStart: Date.now(),
            players: [ { ...defaultPlayer, name: "Spieler A" }, { ...defaultPlayer, name: "Spieler B" } ],
            activePlayer: 0, target: 100, ballsOnTable: 15
        };

        let historyStack = [];

        window.onload = function() { loadState(); render(); };

        function pushHistory() {
            if(historyStack.length > 50) historyStack.shift();
            historyStack.push(JSON.parse(JSON.stringify(state)));
        }

        // --- Actions ---
        function actionPoint() {
            pushHistory();
            const p = state.players[state.activePlayer];
            p.run++; p.total++;
            if(p.run > p.highRun) p.highRun = p.run;
            p.consecutiveFouls = 0; 
            if(state.ballsOnTable > 0) state.ballsOnTable--;
            if(state.ballsOnTable === 1) state.ballsOnTable = 15; 
            saveAndRender();
        }

        function actionMinusOne() {
            const p = state.players[state.activePlayer];
            if(p.run > 0) {
                pushHistory();
                p.run--; p.total--;
                if(state.ballsOnTable < 15) state.ballsOnTable++;
                saveAndRender();
            }
        }

        function actionRack() {
            pushHistory();
            const p = state.players[state.activePlayer];
            let pointsToAdd = state.ballsOnTable > 1 ? (state.ballsOnTable - 1) : 0;
            p.total += pointsToAdd; p.run += pointsToAdd;
            if(p.run > p.highRun) p.highRun = p.run;
            p.consecutiveFouls = 0; state.ballsOnTable = 15;
            saveAndRender();
        }

        function actionSafety() { pushHistory(); state.players[state.activePlayer].safeties++; state.players[state.activePlayer].consecutiveFouls = 0; endInning('safe'); }
        function actionMiss() { pushHistory(); state.players[state.activePlayer].misses++; state.players[state.activePlayer].consecutiveFouls = 0; endInning('miss'); }
        function actionFoul() { 
            pushHistory(); const p = state.players[state.activePlayer]; 
            p.consecutiveFouls++; p.fouls++; 
            if (p.consecutiveFouls >= 3) { p.total -= 15; alert(`‚ö†Ô∏è 3. Foul!\n-15 Punkte & Re-Rack.`); p.consecutiveFouls = 0; state.ballsOnTable = 15; } 
            else { p.total--; } 
            endInning('foul'); 
        }

        function endInning(type = 'standard') {
            const p = state.players[state.activePlayer];
            let now = Date.now();
            let durationSec = (now - state.currentInningStart) / 1000;
            
            p.inningLogs.push({ duration: durationSec, run: p.run, type: type, timestamp: now });
            state.currentInningStart = now; 
            p.innings++; p.run = 0;
            switchPlayer(); saveAndRender();
        }

        function actionUndo() {
            if (historyStack.length === 0) return;
            state = historyStack.pop();
            saveAndRender();
        }

        function switchPlayer() { state.activePlayer = state.activePlayer === 0 ? 1 : 0; }
        function setManualActive(index) { 
            if(state.activePlayer !== index) { 
                pushHistory(); state.currentInningStart = Date.now(); 
                state.players[state.activePlayer].run = 0; state.activePlayer = index; saveAndRender(); 
            } 
        }

        // --- Dialogs ---
        function openBallSelect() {
            const grid = document.getElementById('ballGrid'); grid.innerHTML = '';
            for(let i=0; i<=15; i++) {
                let btn = document.createElement('button'); btn.className = 'ball-btn'; btn.innerText = i;
                if(i === state.ballsOnTable) btn.classList.add('current');
                if(i > state.ballsOnTable) btn.classList.add('disabled'); else btn.onclick = function() { selectBalls(i); };
                grid.appendChild(btn);
            }
            document.getElementById('ballModal').style.display = 'flex';
        }

        function selectBalls(n) {
            pushHistory();
            let diff = state.ballsOnTable - n; 
            const p = state.players[state.activePlayer];
            p.run += diff; p.total += diff;
            if(p.run > p.highRun) p.highRun = p.run;
            if(diff > 0) p.consecutiveFouls = 0; 
            state.ballsOnTable = n; if(state.ballsOnTable === 1) state.ballsOnTable = 15;
            document.getElementById('ballModal').style.display = 'none'; saveAndRender();
        }

        // --- GRAPH ENGINE ---
        function openGraph() {
            const container = document.getElementById('matchChart');
            container.innerHTML = '';
            
            // Merge logs to create timeline
            let p0Logs = state.players[0].inningLogs.map(l => ({...l, p:0}));
            let p1Logs = state.players[1].inningLogs.map(l => ({...l, p:1}));
            let allLogs = [...p0Logs, ...p1Logs].sort((a,b) => a.timestamp - b.timestamp);

            // Find Max for scaling
            let maxRun = 10; // min height
            allLogs.forEach(l => { if(l.run > maxRun) maxRun = l.run; });

            allLogs.forEach(log => {
                let group = document.createElement('div');
                group.className = 'chart-bar-group';
                
                let bar = document.createElement('div');
                bar.className = `chart-bar p${log.p}`;
                // Height percentage (max 100%)
                let h = (log.run / maxRun) * 100;
                bar.style.height = Math.max(5, h) + "%"; // min 5% visibility
                
                if(log.run > 0) {
                    let label = document.createElement('span');
                    label.className = 'chart-label';
                    label.innerText = log.run;
                    group.appendChild(label);
                }
                
                group.appendChild(bar);
                container.appendChild(group);
            });

            document.getElementById('graphModal').style.display = 'flex';
        }

        function calculateStats(p) {
            let avg = (p.total / (p.innings === 0 && p.total > 0 ? 1 : Math.max(1, p.innings))).toFixed(2);
            let positivePots = Math.max(0, p.total); 
            let estimatedPots = positivePots + p.fouls;
            let attempts = estimatedPots + p.misses + p.fouls; 
            let pct = attempts === 0 ? 100 : Math.round((estimatedPots / attempts) * 100);
            return { avg, pct };
        }

        function calculateRunDist(p) {
            let low = 0, mid = 0, high = 0;
            p.inningLogs.forEach(l => {
                if(l.run > 0 && l.run < 5) low++;
                else if(l.run >= 5 && l.run < 15) mid++;
                else if(l.run >= 15) high++;
            });
            return { low, mid, high };
        }

        function formatTime(ts) { if(!ts) return "-"; return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

        function calculateTimeStats(p) {
            if (p.inningLogs.length === 0) return { avg: "0s", fast: "-", slow: "-", safeAvg: "-", errAvg: "-" };
            let total=0, safeSum=0, safeCnt=0, errSum=0, errCnt=0;
            let minSpb = Infinity, maxSpb = 0;

            p.inningLogs.forEach(log => {
                total += log.duration;
                if (log.run > 0) {
                    let spb = log.duration / log.run;
                    if (spb < minSpb) minSpb = spb;
                    if (spb > maxSpb) maxSpb = spb;
                }
                if (log.type === 'safe') { safeSum += log.duration; safeCnt++; }
                else if (log.type === 'miss' || log.type === 'foul') { errSum += log.duration; errCnt++; }
            });

            return {
                avg: Math.round(total/p.inningLogs.length) + "s",
                fast: minSpb===Infinity?"-":Math.round(minSpb)+"s",
                slow: maxSpb===0?"-":Math.round(maxSpb)+"s",
                safeAvg: safeCnt===0?"-":Math.round(safeSum/safeCnt)+"s",
                errAvg: errCnt===0?"-":Math.round(errSum/errCnt)+"s"
            };
        }

        function render() {
            const p0 = state.players[0]; const p1 = state.players[1]; const active = state.activePlayer;
            if ((p0.total >= state.target || p1.total >= state.target) && !state.gameEndTime) state.gameEndTime = Date.now();
            else if (p0.total < state.target && p1.total < state.target) state.gameEndTime = null;

            document.getElementById('balls-display').innerText = `${state.ballsOnTable} B√§lle`;
            
            // Rack Button
            const rackBtn = document.getElementById('btn-rack');
            let potPts = state.ballsOnTable > 1 ? (state.ballsOnTable - 1) : 0;
            if (potPts > 0) { rackBtn.innerHTML = `+${potPts} <span class="btn-subtext">REST & RACK</span>`; rackBtn.style.backgroundColor = "var(--accent-blue)"; } 
            else { rackBtn.innerHTML = `RACK <span class="btn-subtext">Neu aufbauen</span>`; rackBtn.style.backgroundColor = "#555"; }

            // Cards & Warnings
            document.getElementById('p0-card').className = `player-card ${active === 0 ? 'active' : ''}`;
            document.getElementById('p1-card').className = `player-card ${active === 1 ? 'active' : ''}`;
            document.getElementById('p0-foul-warn').style.display = (p0.consecutiveFouls === 2) ? 'block' : 'none';
            document.getElementById('p1-foul-warn').style.display = (p1.consecutiveFouls === 2) ? 'block' : 'none';
            document.getElementById('p0-win').style.display = (p0.total >= state.target) ? 'block' : 'none';
            document.getElementById('p1-win').style.display = (p1.total >= state.target) ? 'block' : 'none';

            // Scores
            document.getElementById('p0-total').innerText = p0.total; document.getElementById('p0-run').innerText = p0.run;
            document.getElementById('p1-total').innerText = p1.total; document.getElementById('p1-run').innerText = p1.run;

            // Mini Stats
            const s0 = calculateStats(p0); const s1 = calculateStats(p1);
            document.getElementById('p0-inn').innerText = p0.innings; document.getElementById('p0-avg').innerText = s0.avg;
            document.getElementById('p0-hr').innerText = p0.highRun; document.getElementById('p0-pct').innerText = s0.pct + "%";
            document.getElementById('p1-inn').innerText = p1.innings; document.getElementById('p1-avg').innerText = s1.avg;
            document.getElementById('p1-hr').innerText = p1.highRun; document.getElementById('p1-pct').innerText = s1.pct + "%";
        }

        function openStats() {
            const p0 = state.players[0]; const p1 = state.players[1];
            const s0 = calculateStats(p0); const s1 = calculateStats(p1);
            const d0 = calculateRunDist(p0); const d1 = calculateRunDist(p1);

            // Fill General Stats
            document.getElementById('st-p0-total').innerText = p0.total; document.getElementById('st-p1-total').innerText = p1.total;
            document.getElementById('st-p0-inn').innerText = p0.innings; document.getElementById('st-p1-inn').innerText = p1.innings;
            document.getElementById('st-p0-avg').innerText = s0.avg; document.getElementById('st-p1-avg').innerText = s1.avg;
            document.getElementById('st-p0-hr').innerText = p0.highRun; document.getElementById('st-p1-hr').innerText = p1.highRun;
            document.getElementById('st-p0-qt').innerText = s0.pct+"%"; document.getElementById('st-p1-qt').innerText = s1.pct+"%";
            document.getElementById('st-p0-safe').innerText = p0.safeties; document.getElementById('st-p1-safe').innerText = p1.safeties;
            document.getElementById('st-p0-miss').innerText = p0.misses; document.getElementById('st-p1-miss').innerText = p1.misses;
            document.getElementById('st-p0-fouls').innerText = p0.fouls; document.getElementById('st-p1-fouls').innerText = p1.fouls;

            // Fill Distribution
            document.getElementById('d-p0-low').innerText = d0.low; document.getElementById('d-p1-low').innerText = d1.low;
            document.getElementById('d-p0-mid').innerText = d0.mid; document.getElementById('d-p1-mid').innerText = d1.mid;
            document.getElementById('d-p0-high').innerText = d0.high; document.getElementById('d-p1-high').innerText = d1.high;

            document.getElementById('statsModal').style.display = 'flex';
        }

        function openTimeStats() {
            const t0 = calculateTimeStats(state.players[0]); const t1 = calculateTimeStats(state.players[1]);
            document.getElementById('th-p0-t').innerText = state.players[0].name; document.getElementById('th-p1-t').innerText = state.players[1].name;
            document.getElementById('t-start').innerText = formatTime(state.gameStartTime);
            document.getElementById('t-end').innerText = state.gameEndTime ? formatTime(state.gameEndTime) : "l√§uft...";
            
            document.getElementById('t-p0-avg').innerText = t0.avg; document.getElementById('t-p1-avg').innerText = t1.avg;
            document.getElementById('t-p0-safe-avg').innerText = t0.safeAvg; document.getElementById('t-p1-safe-avg').innerText = t1.safeAvg;
            document.getElementById('t-p0-err-avg').innerText = t0.errAvg; document.getElementById('t-p1-err-avg').innerText = t1.errAvg;
            document.getElementById('t-p0-fast').innerText = t0.fast; document.getElementById('t-p1-fast').innerText = t1.fast;
            document.getElementById('t-p0-slow').innerText = t0.slow; document.getElementById('t-p1-slow').innerText = t1.slow;
            
            document.getElementById('timeModal').style.display = 'flex';
        }

        function saveAndRender() { saveState(); render(); }
        function saveState() { localStorage.setItem('141_v7_analyst', JSON.stringify(state)); }
        function loadState() {
            const saved = localStorage.getItem('141_v7_analyst');
            if (saved) {
                try {
                    let loaded = JSON.parse(saved);
                    // Migrations
                    if(typeof loaded.ballsOnTable === 'undefined') loaded.ballsOnTable = 15;
                    loaded.players.forEach(p => { if(!p.inningLogs) p.inningLogs = []; });
                    state = loaded;
                    document.getElementById('p0-name').value = state.players[0].name;
                    document.getElementById('p1-name').value = state.players[1].name;
                    document.getElementById('targetScore').value = state.target;
                } catch(e) {}
            }
        }
        function updateSettings() { state.players[0].name=document.getElementById('p0-name').value; state.players[1].name=document.getElementById('p1-name').value; state.target=parseInt(document.getElementById('targetScore').value)||100; saveAndRender(); }
        function resetGame(ask) { if(ask) document.getElementById('resetModal').style.display='flex'; else { state.players=[{...defaultPlayer, name:state.players[0].name},{...defaultPlayer, name:state.players[1].name}]; state.activePlayer=0; state.ballsOnTable=15; state.gameStartTime=Date.now(); state.gameEndTime=null; state.currentInningStart=Date.now(); historyStack=[]; saveAndRender(); } }
        function confirmReset() { resetGame(false); closeModal(); }
        function closeModal() { document.getElementById('resetModal').style.display='none'; }
    </script>
</body>
</html>
